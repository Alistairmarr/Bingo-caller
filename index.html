<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>
<title>Bingo Caller</title>
<style>
  :root{
    /* Left column width ≈ 40% of viewport height (like 40vmin) */
    --numColFractionOfHeight: 0.40;
    --gap: 10px;
    --panelRadius: 16px;
    --primary: #e53935;
    --primaryDark: #d32f2f;
    --accent: #3ea6ff;
    --called: #fff59d;
    --bg1: #0c0f1a;
    --bg2: #181c30;
    --text: #f5f7ff;
    --subtle: #9aa1b2;
    --shadow: 0 8px 28px rgba(0,0,0,0.35);
  }

  html, body {
    margin: 0;
    height: 100%;
    background: radial-gradient(1200px 800px at 20% 10%, #1a2340 0%, #0e1120 60%, #05060b 100%);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans";
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
  }

  .root {
    position: relative;
    display: grid;
    grid-template-columns: var(--leftWidthPx) 1fr;
    gap: var(--gap);
    padding: var(--gap);
    box-sizing: border-box;
    height: 100%;
    width: 100%;
  }

  .panel {
    background: linear-gradient(180deg, var(--bg2), var(--bg1));
    border-radius: var(--panelRadius);
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.04);
  }

  /* LEFT: big number, BIG red NEXT, counter, reset */
  .leftCol {
    display: grid;
    grid-template-rows: 1fr auto auto auto;
    gap: var(--gap);
    min-width: 280px;
  }

  .bigNumberPanel {
    display: grid;
    place-items: center;
    position: relative;
    overflow: hidden;
  }

  .bigNumber {
    font-variant-numeric: tabular-nums;
    font-weight: 800;
    line-height: 0.9;
    letter-spacing: -0.02em;
    text-shadow: 0 12px 24px rgba(0,0,0,0.5);
    font-size: 24vmin; /* will be resized by JS */
    will-change: transform;
    transform-origin: center;
    user-select: none;
  }

  @keyframes breathe {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }
  .breathe { animation: breathe 5.5s ease-in-out infinite; }

  @keyframes pop {
    0%   { transform: scale(1); }
    35%  { transform: scale(1.16); }
    100% { transform: scale(1); }
  }
  .pop { animation: pop 400ms cubic-bezier(.34,1.56,.64,1); }

  .rowPad { padding: 12px; }

  .counterRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  .counter {
    font-weight: 700;
  }
  .ver {
    opacity: .65; font-size: .9rem;
  }

  .btn {
    background: var(--bg2);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 18px;
    color: var(--text);
    font-size: 1.35rem;
    font-weight: 800;
    padding: 18px 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: var(--shadow);
    user-select: none;
    touch-action: manipulation;
    position: relative;
  }
  .btn:active { transform: translateY(1px); }

  /* >>> BIG RED NEXT BUTTON <<< */
  .btnNextBig {
    background: linear-gradient(180deg, var(--primary), var(--primaryDark));
    border-color: rgba(0,0,0,0.25);
    font-size: 2.0rem;
    padding: 26px 22px;
    letter-spacing: 0.02em;
  }
  .btn[disabled] { opacity: .6; cursor: not-allowed; }

  .cooldownOverlay {
    position: absolute; inset: 0; display: grid; place-items: center;
    background: rgba(0,0,0,0.25);
    border-radius: inherit; pointer-events: none;
  }
  .spinner {
    width: 30px; height: 30px;
    border: 3px solid rgba(255,255,255,0.25);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 900ms linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .resetRow { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
  .label { opacity:.75 }

  /* RIGHT: grid and recent */
  .rightCol {
    display: grid;
    /* two rows: grid area (takes all remaining space), recent strip auto height */
    grid-template-rows: 1fr auto;
    gap: var(--gap);
    min-width: 520px;
    min-height: 0; /* allow child to measure correctly */
  }

  .gridPanel {
    padding: var(--gap);
    box-sizing: border-box;
    position: relative;
    min-height: 0; /* critical for proper height measuring */
  }

  /* The grid gets sized ONLY by JS via --cellPx */
  .grid {
    display: grid;
    grid-template-rows: repeat(10, var(--cellPx));
    grid-template-columns: repeat(9, var(--cellPx));
    gap: 4px;
    justify-content: center;
    align-content: center;
    width: 100%;
    height: 100%;
  }

  .cell {
    display: grid; place-items: center;
    border-radius: 10px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    user-select: none;
  }
  .cell.called {
    background: var(--called); color: #1d1d1d; border-color: rgba(0,0,0,0.15);
  }
  .cell.current {
    outline: 2px solid var(--accent);
    box-shadow: 0 0 0 4px rgba(62,166,255,0.15), 0 0 28px 4px rgba(62,166,255,0.25) inset;
    animation: cellPulse 1200ms ease-in-out infinite;
  }
  @keyframes cellPulse {
    0% { box-shadow: 0 0 0 4px rgba(62,166,255,0.12), 0 0 18px 2px rgba(62,166,255,0.18) inset; }
    50% { box-shadow: 0 0 0 6px rgba(62,166,255,0.2), 0 0 36px 6px rgba(62,166,255,0.35) inset; }
    100% { box-shadow: 0 0 0 4px rgba(62,166,255,0.12), 0 0 18px 2px rgba(62,166,255,0.18) inset; }
  }

  .recentPanel {
    padding: 10px;
    display: grid;
    grid-auto-flow: column;
    gap: 8px;
    overflow-x: auto;
    overscroll-behavior-x: contain;
  }
  .chip {
    min-width: 44px; padding: 8px 10px; border-radius: 999px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    text-align: center; font-weight: 700; font-variant-numeric: tabular-nums;
    user-select: none; white-space: nowrap;
  }
  .chip.newest { background: rgba(62,166,255,0.22); border-color: rgba(62,166,255,0.6); }

  @media (orientation: portrait) {
    .root {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
    }
    .rightCol { min-width: 0; }
  }

  .toolsRow {
    position: absolute; top: 8px; right: 8px; display: flex; gap: 8px; z-index: 10;
  }
  .tinyBtn {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text);
    padding: 6px 10px; border-radius: 10px; font-size: 12px; cursor: pointer;
  }
  .tinyBtn:active { transform: translateY(1px); }

  .sr-live { position:absolute; left:-10000px; width:1px; height:1px; overflow:hidden; }
</style>
</head>
<body>
  <div class="root" id="app" role="application" aria-label="Bingo Caller">
    <div class="toolsRow">
      <button class="tinyBtn" id="btnFullscreen" title="Fullscreen">Fullscreen</button>
      <button class="tinyBtn" id="btnWake" title="Stay awake">Stay Awake</button>
    </div>

    <!-- LEFT -->
    <div class="leftCol">
      <div class="panel bigNumberPanel" aria-live="polite" aria-atomic="true">
        <div id="bigNumber" class="bigNumber breathe" role="status" aria-label="Current number">—</div>
      </div>

      <!-- BIG RED NEXT BUTTON -->
      <button id="btnNext" class="panel btn btnNextBig" aria-label="Next number">NEXT</button>

      <div class="panel rowPad counterRow">
        <div class="counter" id="counter">Drawn: 0 / 90</div>
        <div class="ver">v1.0.1</div>
      </div>

      <div class="panel rowPad resetRow">
        <div class="label">Newest:</div>
        <div id="newest" style="text-align:right;font-weight:800;font-variant-numeric:tabular-nums">—</div>
        <button id="btnReset" class="btn" aria-label="Reset and reshuffle">RESET</button>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="rightCol">
      <div class="panel gridPanel">
        <div id="grid" class="grid" aria-label="Numbers grid"></div>
      </div>

      <div class="panel recentPanel" id="recent" aria-label="Recent numbers strip"></div>
    </div>
  </div>

  <div id="live" class="sr-live" aria-live="assertive" aria-atomic="true"></div>

<script>
(function(){
  "use strict";

  const NUMBERS = 90, ROWS = 10, COLS = 9, COOLDOWN_MS = 1000;
  const LEFT_FRACTION = 0.40;
  const STORAGE_KEY = 'bingo_state_v1';
  const SNAPSHOT_KEY = 'bingo_snapshot_v1';

  const els = {
    grid: document.getElementById('grid'),
    bigNumber: document.getElementById('bigNumber'),
    counter: document.getElementById('counter'),
    newest: document.getElementById('newest'),
    recent: document.getElementById('recent'),
    btnNext: document.getElementById('btnNext'),
    btnReset: document.getElementById('btnReset'),
    btnFullscreen: document.getElementById('btnFullscreen'),
    btnWake: document.getElementById('btnWake'),
    live: document.getElementById('live')
  };

  let coolingDown = false;
  let wakeLock = null;

  let state = { numbers: [], index: -1, seed: 0, updatedAt: 0 };

  const nowTs = () => Date.now();
  function seededRandom(seed) {
    let t = seed >>> 0;
    return function() {
      t += 0x6D2B79F5;
      let r = Math.imul(t ^ (t >>> 15), 1 | t);
      r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
      return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    };
  }
  function fisherYatesShuffle(arr, rand) {
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(rand()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function saveState(){
    state.updatedAt = nowTs();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    localStorage.setItem(SNAPSHOT_KEY, JSON.stringify({
      sequence: state.numbers,
      index: state.index,
      seed: state.seed,
      updatedAt: state.updatedAt,
      drawn: state.index + 1,
      remaining: Math.max(0, NUMBERS - (state.index + 1))
    }, null, 2));
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      if(!Array.isArray(obj.numbers) || obj.numbers.length!==NUMBERS) return false;
      state = obj; return true;
    }catch{ return false; }
  }

  function resetGame(confirmNeeded=true){
    if(confirmNeeded && !confirm('Reset game and reshuffle?')) return;
    state.seed = Math.floor(Math.random()*0xFFFFFFFF);
    const rand = seededRandom(state.seed);
    state.numbers = Array.from({length:NUMBERS},(_,i)=>i+1);
    fisherYatesShuffle(state.numbers, rand);
    state.index = -1;
    saveState();
    renderAll();
    announce('Game reset. Ready.');
  }

  function currentNumber(){ return state.index>=0 ? state.numbers[state.index] : null; }
  function recentList(limit=10){
    const start = Math.max(0, state.index - limit + 1);
    return state.numbers.slice(start, state.index+1).reverse();
  }
  function isCalled(n){ return state.index>=0 && state.numbers.indexOf(n) <= state.index; }

  function setLeftWidthFromHeight(){
    const h = window.innerHeight;
    const px = Math.floor(h * LEFT_FRACTION);
    document.documentElement.style.setProperty('--leftWidthPx', px+'px');
  }

  function exactInnerBox(el){
    const st = getComputedStyle(el);
    const padX = parseFloat(st.paddingLeft)+parseFloat(st.paddingRight);
    const padY = parseFloat(st.paddingTop)+parseFloat(st.paddingBottom);
    const bW = el.clientWidth - padX;
    const bH = el.clientHeight - padY;
    return {w: Math.max(0,bW), h: Math.max(0,bH)};
  }

  function sizeGridCells(){
    // make sure the grid always fits vertically:
    const gridPanel = document.querySelector('.gridPanel');
    const {w:availW, h:availH} = exactInnerBox(gridPanel);

    const gap = 4;
    const cellW = Math.floor((availW - gap*(COLS-1)) / COLS);
    const cellH = Math.floor((availH - gap*(ROWS-1)) / ROWS);
    const cell = Math.max(22, Math.min(cellW, cellH));
    document.documentElement.style.setProperty('--cellPx', cell+'px');
  }

  function fitBigNumber(){
    const panel = document.querySelector('.bigNumberPanel');
    const {h} = exactInnerBox(panel);
    const target = Math.max(28, Math.floor(h*0.72));
    els.bigNumber.style.fontSize = target+'px';
  }

  function reflow(){
    setLeftWidthFromHeight();
    sizeGridCells();
    fitBigNumber();
  }

  function renderGrid(){
    if(!els.grid.hasChildNodes()){
      const frag = document.createDocumentFragment();
      for(let r=0;r<10;r++){
        for(let c=0;c<9;c++){
          const n = r*9 + c + 1;
          const div = document.createElement('div');
          div.className='cell';
          div.textContent = n.toString();
          div.id = `cell-${n}`;
          frag.appendChild(div);
        }
      }
      els.grid.appendChild(frag);
    }
    const cur = currentNumber();
    for(let n=1;n<=90;n++){
      const cell = document.getElementById(`cell-${n}`);
      cell.classList.toggle('called', isCalled(n));
      cell.classList.toggle('current', cur===n);
    }
  }

  function renderRecent(){
    const arr = recentList(10);
    els.recent.replaceChildren();
    arr.forEach((n,i)=>{
      const chip = document.createElement('div');
      chip.className = 'chip' + (i===0?' newest':'');
      chip.textContent = n.toString();
      els.recent.appendChild(chip);
    });
    els.newest.textContent = arr.length ? arr[0].toString() : '—';
  }

  function renderCounter(){
    els.counter.textContent = `Drawn: ${state.index + 1} / ${NUMBERS}`;
  }

  function renderBigNumber(pop=false){
    const n = currentNumber();
    els.bigNumber.textContent = n!=null ? n.toString().padStart(2,' ') : '—';
    if(pop){
      els.bigNumber.classList.remove('pop');
      void els.bigNumber.offsetWidth;
      els.bigNumber.classList.add('pop');
    }
  }

  function renderAll(pop=false){
    renderGrid(); renderRecent(); renderCounter(); renderBigNumber(pop);
  }

  function announce(text){
    const live = document.getElementById('live');
    live.textContent = text;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.0; speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch{}
  }
  function haptics(){ if('vibrate' in navigator) navigator.vibrate(20); }

  function startCooldown(){
    coolingDown = true;
    els.btnNext.setAttribute('disabled','true');
    let overlay = els.btnNext.querySelector('.cooldownOverlay');
    if(!overlay){
      overlay = document.createElement('div');
      overlay.className = 'cooldownOverlay';
      overlay.innerHTML = '<div class="spinner" role="progressbar" aria-label="Cooling down"></div>';
      els.btnNext.appendChild(overlay);
    }
    overlay.style.display='grid';
    setTimeout(()=>{
      coolingDown=false;
      els.btnNext.removeAttribute('disabled');
      overlay.style.display='none';
    }, COOLDOWN_MS);
  }

  function onNext(){
    if(coolingDown) return;
    if(state.index >= NUMBERS-1){ announce("All numbers drawn."); return; }
    state.index += 1; saveState(); renderAll(true); startCooldown(); haptics();
    const n = currentNumber(); if(typeof n === 'number') announce(`Number ${n}`);
  }
  function onReset(){
    resetGame(true);
  }

  document.addEventListener('keydown',(e)=>{
    if(e.code==='Space'){ e.preventDefault(); onNext(); }
  });

  async function requestFullscreen(){
    const docEl = document.documentElement;
    if(document.fullscreenElement){ await document.exitFullscreen(); }
    else { await docEl.requestFullscreen({navigationUI:"hide"}).catch(()=>{}); }
  }
  async function requestWakeLock(){
    try{
      if('wakeLock' in navigator){
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', ()=>{});
      } else {
        // noop
      }
    }catch(e){ console.warn('WakeLock', e); }
  }

  function init(){
    els.btnNext.addEventListener('click', onNext);
    els.btnReset.addEventListener('click', onReset);
    els.btnFullscreen.addEventListener('click', requestFullscreen);
    els.btnWake.addEventListener('click', requestWakeLock);

    const ro = new ResizeObserver(()=>{ reflow(); });
    ro.observe(document.body);

    window.addEventListener('orientationchange', ()=>{ setTimeout(reflow, 100); });

    if(!loadState()) resetGame(false);
    renderAll(false);
    reflow();

    requestWakeLock();
  }

  init();
})();
</script>
</body>
</html>
